var consts = require('constants');
var assert = require('assert');
var moment = require('moment');
var store = require('./store');

var minRegex = /\d(m|minute(s?))/g;
var hourRegex = /\d(h|hour(s?))/ig;
var daysRegex = /\d(d|day(s?))/ig;
var weeksRegex = /\d(w|week(s?))/ig;
var monthsRegex = /\d(M|month(s?))/g;
var yearsRegex = /\d(y|year(s?))/ig;

function Ban(start, end, reason) {
    this.start = start;
    this.end = end;
    this.reason = reason;
}

function getDuration(duration) {
    // we can do basic durations like 1w(eek), or complex like 3months2weeks4days
    var minutes = getNumberFromString(minRegex.exec(duration)[0]);
    var hours = getNumberFromString(hourRegex.exec(duration)[0]);
    var days = getNumberFromString(daysRegex.exec(duration)[0]);
    var weeks = getNumberFromString(weeksRegex.exec(duration));
    var months = getNumberFromString(monthsRegex.exec(duration)[0]);
    var years = getNumberFromString(yearsRegex.exec(duration)[0]);

    if (minutes === 0 &&
        hours === 0 &&
        days === 0 &&
        weeks === 0 &&
        months === 0 &&
        years === 0) return false;

    return moment.duration({
        minutes,
        hours,
        days,
        weeks,
        months,
        years
    });
}

function getNumberFromString(input) {
    if (!input) return 0;
    var result = '';
    for (var i = 0; i < input.length; ++i) {
        if (parseInt(input[i]) !== NaN) result += input[i];
        else break;
    }
    return parseInt(result);
}

registerCommand({
    name: 'banp',
    description: 'Bans a player or IP.',
    usage: '\xA7c/<command> [player] [duration] [reason] (-ip)'
}, function(sender, label, args) {
    assert(sender.hasPermission('banp.ban', consts.defaultPermissionMessage));
    if (!args || args.length < 3) return false;
    var player = args[0];
    var duration = getDuration(args[1]);
    if (duration === false) {
        sender.sendMessage('\xA7eThe duration must be longer than 0 (ex: 1day, 3weeks, 4h)');
        return;
    }

    var reason = args[2];
    var isIpBan = args[3] === '-ip';

    var ban = new Ban(moment(), moment().add(duration), reason);
    var result = null;
    if (isIpBan) {
        store.addIpBan()
    }
});